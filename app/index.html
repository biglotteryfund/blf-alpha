<!doctype html>
<html>
<head>
    <title>Big Lottery Fund</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=yes' />
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>

    <h1>What did we fund near you?</h1>
    <form id="js-lookup">
        <input type="text" name="postcode" placeholder="eg. SW2 3BJ" id="js-postcode">
        <input type="submit" value="Look up awards">
        <article>
            <ul id="js-results"></ul>
        </article>
    </form>


    <h1>Our year in numbers</h1>
    <h2>Key statistics</h2>
    <dl>
        <dt>Number of awards made</dt>
        <dd>11,779</dd>

        <dt>Percentage of awards to the voluntary and community sectors</dt>
        <dd>91.3%</dd>

        <dt>Percentage of awards for less than &pound;10,000</dt>
        <dd>89.1%</dd>

        <dt>Largest award made to the Royal Society of Wildlife Trusts</dt>
        <dd>&pound;33 million</dd>

        <dt>Total operating costs</dt>
        <dd>6.6%</dd>

        <dt>Smallest award made through the Communities and Families Fund</dt>
        <dd>&pound;276</dd>
    </dl>

    <div id='map' style='width: 100%; height: 450px;'></div>

    <p>The value of awards we have made this year is significantly reduced from 2014/15. This is due to the timing of grant decisions and does not represent an on-going change in our capacity to make grant awards.</p>

    <p>Last year's grant awards were unusually high due to the award of &pound;149 million to the Power to Change Trust, whereas this year is lower than anticipated as a result of some delays to our European matched funding property.</p>

    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>-->
    <script src="app.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.js'></script>

    <script>

        var grantData = [
            {
                "name": "South West",
                "cartodb_id": 6,
                "totalAwarded": 36520521.98,
                "numGrants": 1016
            },
            {
                "name": "Scotland",
                "cartodb_id": 13,
                "totalAwarded": 111276238.98,
                "numGrants": 3008
            },
            {
                "name": "East Midlands",
                "cartodb_id": 7,
                "totalAwarded": 71704233.38999999,
                "numGrants": 851
            },
            {
                "name": "West Midlands",
                "cartodb_id": 4,
                "totalAwarded": 47640121.46,
                "numGrants": 1088
            },
            {
                "name": "London",
                "cartodb_id": 3,
                "totalAwarded": 223806798.16999996,
                "numGrants": 1365
            },
            {
                "name": "East of England",
                "cartodb_id": 9,
                "totalAwarded": 58675152.62999999,
                "numGrants": 674
            },
            {
                "name": "North East",
                "cartodb_id": 1,
                "totalAwarded": 34707389.940000005,
                "numGrants": 554
            },
            {
                "name": "Northern Ireland",
                "cartodb_id": 12,
                "totalAwarded": 12851020.13,
                "numGrants": 592
            },
            {
                "name": "South East Coast",
                "cartodb_id": 8,
                "totalAwarded": 17687173.56,
                "numGrants": 527
            },
            {
                "name": "Yorkshire and the Humber",
                "cartodb_id": 5,
                "totalAwarded": 88337519.25999996,
                "numGrants": 981
            },
            {
                "name": "South Central",
                "cartodb_id": 6,
                "totalAwarded": 16297303.830000002,
                "numGrants": 389
            },
            {
                "name": "North West",
                "cartodb_id": 2,
                "totalAwarded": 110342378.00000001,
                "numGrants": 1418
            },
            {
                "name": "Wales",
                "cartodb_id": 11,
                "totalAwarded": 25316250.32,
                "numGrants": 960
            }
        ];

        var getGrantDataById = (id) => grantData.find(g => g.cartodb_id === id);

        var formatCurrency = function (n) {
            return n.toFixed(2).replace(/./g, function(c, i, a) {
                return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
            });
        };

        mapboxgl.accessToken = 'pk.eyJ1IjoibWF0dGFuZHJld3MiLCJhIjoiY2owczczbWQ2MDAycjMycWxlaTBwOTIzYSJ9.kymhXY2DQq4xyb1Cf5qH2g';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v9',
            center: [-1.890401, 52.486243],
            zoom: 4
        });

        var regionLayerName = 'regions';

        map.on('load', function () {
            map.addLayer({
                id: regionLayerName,
                type: 'fill',
                source: {
                    type: 'geojson',
                    data: './geojson/regions.json'
                },
                'layout': {},
                'paint': {
                    'fill-color': '#088',
                    'fill-opacity': 0.8,
                    'fill-outline-color': '#ffffff',
                }
            });
            var nav = new mapboxgl.NavigationControl();
            map.addControl(nav, 'top-left');
        });

        map.on('click', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: [regionLayerName] });
            if (!features.length) { return; }
            var feature = features[0];

            var data = getGrantDataById(feature.properties.cartodb_id);

            var html = `<div class="map-popup-box">
                <h2>${feature.properties.name}</h2>
                <ul>
                    <li><strong>Grants made</strong>: ${data.numGrants}</li>
                    <li><strong>Grants made</strong>: &pound;${formatCurrency(data.totalAwarded)}</li>
                </ul>
            </div>`;

            var popup = new mapboxgl.Popup()
                .setLngLat(map.unproject(e.point))
                .setHTML(html)
                .addTo(map);
        });
    </script>

</body>
</html>
