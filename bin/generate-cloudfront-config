#!/usr/bin/env node
'use strict';
const { forEach } = require('lodash');
const config = require('config');
const fs = require('fs');
const path = require('path');

const { generateBehaviours } = require('../common/cloudfront');

const cloudfrontDistributions = config.get('aws.cloudfrontDistributions');

/**
 * For each CloudFront distribution generate a config and store it
 */
forEach(cloudfrontDistributions, function(distribution, distributionName) {
    const behaviours = generateBehaviours(distribution.origins);

    const filePath = path.join(
        __dirname,
        `../config/cloudfront/${distributionName}.json`
    );

    fs.writeFile(
        filePath,
        JSON.stringify(behaviours, null, 2),
        'utf8',
        function(err) {
            if (err) {
                console.error('Error saving config', err);
            } else {
                console.log(
                    `[${distributionName}] Cloudfront configuration with ${
                        behaviours.CacheBehaviors.Items.length
                    } behaviours saved at ${path.relative(
                        process.cwd(),
                        filePath
                    )}.`
                );
            }
        }
    );
});
