#!/usr/bin/env node
'use strict';
const { forEach } = require('lodash');
const config = require('config');
const fs = require('fs');
const path = require('path');
const util = require('util');
const writeFile = util.promisify(fs.writeFile);

const { generateBehaviours } = require('../modules/cloudfront');
const routes = require('../controllers/routes');

const cloudfrontDistributions = config.get('aws.cloudfrontDistributions');

/**
 * For each CloudFront distribution generate a config and store it
 */
forEach(cloudfrontDistributions, (distribution, distributionName) => {
    const behaviours = generateBehaviours({
        routesConfig: routes,
        origins: distribution.origins
    });

    const distributionTag = `[${distributionName.toUpperCase()}]`;
    const behaviourCount = behaviours.CacheBehaviors.Items.length;

    const filePath = path.join(__dirname, `../config/cloudfront/${distributionName}.json`);
    const relativeFilePath = path.relative(process.cwd(), filePath);

    writeFile(filePath, JSON.stringify(behaviours, null, 2), 'utf8')
        .then(() => {
            console.log(
                `${distributionTag} Cloudfront configuration with ${behaviourCount} behaviours saved at ${relativeFilePath}.`
            );
        })
        .catch(err => {
            console.error('Error saving config', err);
        });
});
