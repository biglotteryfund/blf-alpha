#!/usr/bin/env node
'use strict';
const config = require('config');
const fs = require('fs');
const path = require('path');

const { generateBehaviours } = require('../common/cloudfront');

const cloudfrontDistributions = config.get('aws.cloudfrontDistributions');

function generateConfig(distribution, distributionName) {
    const filePath = path.join(
        __dirname,
        `../config/cloudfront/${distributionName}.json`
    );

    const data = JSON.stringify(
        generateBehaviours(distribution.origins),
        null,
        2
    );

    fs.writeFile(filePath, data, 'utf8', function(err) {
        if (err) {
            console.error('Error saving config', err);
        } else {
            const relativePath = path.relative(process.cwd(), filePath);
            console.log(
                `[${distributionName}] config saved at ${relativePath}.`
            );
        }
    });
}

Object.entries(cloudfrontDistributions).forEach(function([
    distributionName,
    distribution
]) {
    generateConfig(distribution, distributionName);
});
