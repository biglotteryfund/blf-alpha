#!/usr/bin/env node
require('dotenv').config();

const puppeteer = require('puppeteer');
const devices = require('puppeteer/DeviceDescriptors');

const del = require('del');
const filenamify = require('filenamify');
const makeDir = require('make-dir');

const BASE_URL = process.env.TEST_URL;
if (!BASE_URL) {
    throw new Error('Must define TEST_URL environment variable');
}

const pagesToTest = ['/home' /*, '/over10k', '/under10k'*/];
const devicesToTest = ['iPad landscape', 'Nexus 6P', 'iPhone 5'];

const screenshotsPath = './screenshots';

makeDir.sync(screenshotsPath);
del.sync(`${screenshotsPath}/*`);

pagesToTest.forEach(urlPath => {
    devicesToTest.forEach(deviceName => {
        puppeteer.launch({
            dumpio: true
        }).then(async browser => {
            const page = await browser.newPage();
            await page.emulate(devices[deviceName]);
            await page.goto(`${BASE_URL}${urlPath}`, {
                waitUntil: ['networkidle0']
            });
            const filename = filenamify(
                `Page - ${urlPath} - ${deviceName} - ${(new Date().toISOString())}.jpg`
            );
            await page.screenshot({
                fullPage: true,
                type: 'jpeg',
                quality: 80,
                path: `${screenshotsPath}/${filename}`
            });
            await browser.close();
        }).catch(err => {
            console.log(err);
        });
    });
});
