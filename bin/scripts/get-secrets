#!/usr/bin/env node

'use strict';

const fs = require('fs');
const assert = require('assert');
const AWS = require('aws-sdk');

AWS.config.update({ region: 'eu-west-1' });

var ssm = new AWS.SSM();

const etcDir = '/etc/blf';
const parametersDest = etcDir + '/parameters.json';

ssm.describeParameters(function(err, data) {
    if (err) {
        console.log(err, err.stack);
        process.exit(1);
    }

    const names = data.Parameters.map(_ => _.Name);

    ssm.getParameters(
        {
            Names: names,
            WithDecryption: true
        },
        function(err, data) {
            if (err) {
                console.log(err, err.stack);
                process.exit(1);
            }

            const parameters = data.Parameters;

            if (!fs.existsSync(etcDir)) {
                fs.mkdirSync(etcDir);
            }

            fs.writeFileSync(parametersDest, JSON.stringify(parameters, null, 4));
            assert(fs.existsSync(parametersDest));
        }
    );
});
