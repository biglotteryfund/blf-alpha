{% extends "layouts/main.njk" %}
{% from "components/hero.njk" import hero %}
{% from "components/icons.njk" import iconArrowDown %}
{% from "components/form-fields.njk" import formHeader with context %}

{% block title %}{{ title }} | {{ formTitle }} | {% endblock %}
{% if not heroImage %}{% set bodyClass = 'has-static-header' %}{% endif %}

{% block content %}
    <main role="main" id="content">
        {% if heroImage %}
            {{ hero(
                titleText = title,
                image = heroImage,
                accent = pageAccent
            ) }}
        {% endif %}

        <div class="content-box u-inner-wide-only accent--{{ pageAccent }} a--border-top{% if heroImage %} nudge-up{% endif %}">
            <form action="" method="POST" class="js-application-form js-application-form-review">

            {{ formHeader(
                    title = formTitle,
                    prefix = "Step " + stepProgress.currentStepNumber + " of " + stepProgress.totalSteps,
                    backUrl = stepProgress.prevStepUrl
                ) }}

                <h2>{{ title }}</h2>

                {% for step in summary %}
                    {% set stepCopy = copy.steps[loop.index0] %}
                    <div class="review-step">
                        <h3 class="review-step__title">
                            {{ stepCopy.name or step.name }}
                            <a class="review-step__edit js-application-form-review-link"
                            href="{{ baseUrl }}/{{ loop.index }}/edit"
                            aria-label="Edit {{ step.name }}">
                                Edit
                            </a>
                        </h3>
                        {% for fieldset in step.fieldsets %}
                            <dl class="review-step__list">
                                {% for field in fieldset.fields %}
                                    {% set fieldCopy = copy.fields[field.name] %}
                                    {% set fieldLabel = fieldCopy.label or field.label %}
                                    {% if field.value %}
                                        <dt class="review-step__item-label{% if field.type === 'textarea' %} is-stacked{% endif %}">
                                            {{ fieldLabel }}
                                        </dt>
                                        <dd class="review-step__item-value{% if field.type === 'textarea' %} is-stacked is-constrained{% endif %}">
                                            <div class="s-prose" data-hj-suppress>
                                                {% if field.type === 'textarea' %}
                                                    {% set cleanValue = field.value | striptags(true) | escape | nl2br %}
                                                    {% if cleanValue | wordcount > 50 %}
                                                        <div class="review-step__answer-preview js-toggle-answer">
                                                            {{ cleanValue }}
                                                            <p class="review-step__answer-more">
                                                                <button type="button" class="btn-link">
                                                                    <span class="js-toggle-answer-label" data-toggle-label="Show less">
                                                                        Show more
                                                                    </span>
                                                                    {{ iconArrowDown() }}
                                                                </button>
                                                            </p>
                                                        </div>
                                                    {% else %}
                                                        {{ cleanValue }}
                                                    {% endif %}
                                                {% elseif (field.value | isArray) %}
                                                    {{ field.value | join(', ') }}
                                                {% else %}
                                                    {{ field.value }}
                                                {% endif %}
                                            </div>
                                        </dd>
                                    {% endif %}
                                {% endfor %}
                            </dl>
                        {% endfor %}
                    </div>
                {% endfor %}

                {% if csrfToken %}
                    <input type="hidden" name="_csrf" value="{{ csrfToken }}">
                {% endif %}

                <input class="btn btn--next" type="submit" value="{{ stepCopy.proceedLabel }}" />
            </form>
        </div>
    </main>
{% endblock %}
