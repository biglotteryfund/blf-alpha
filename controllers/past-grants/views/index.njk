{% extends "layouts/main.njk" %}
{% from "components/breadcrumb-trail/macro.njk" import breadcrumbTrail %}
{% from "components/feedback.njk" import inlineFeedback with context %}
{% from "components/form-fields/macros.njk" import inputChoice, inputSelect with context %}
{% from "components/hero.njk" import hero %}
{% from "components/split-nav/macro.njk" import splitNav with context %}
{% from "./grant-results.njk" import grantResultList with context %}

{% block extraHead %}
    <script>
        window._PAST_GRANTS_SEARCH = {
            facets: {{ facets | dump | safe }},
            queryParams: {{ queryParams | dump | safe }},
            totalResults: {{ meta.totalResults }},
            totalAwarded: {{ meta.totalAwarded}},
            sort: {{ meta.currentSort | dump | safe }}
        };
    </script>
{% endblock %}

{% block content %}
    <main role="main">
        {{ hero(
            titleText = title,
            image = heroImage,
            accent = pageAccent
        ) }}

        <div class="nudge-up">
            <div class="content-box u-inner-wide-only accent--{{ pageAccent }} a--border-top">
                {{ breadcrumbTrail(breadcrumbs) }}

                <p><strong>BETA:</strong> Thank you for choosing to use our new “search awarded grants” service. We are working to improve the service we currently offer, your feedback will help us do that.</p>

                {{ inlineFeedback(
                    description = "past_grants_beta",
                    promptLabel = "Can you spare a minute to give us some feedback?",
                    fieldLabel = "Tell us why you came to this page today"
                )  }}
            </div>

            <form class="u-inner" id="js-past-grants" method="get" action="" v-on:submit.prevent>
                {# @TODO: Reinstate this #}
                {# <span>
                    {% if queryParams.recipient %}
                        <small v-show="filters.recipient">(Recipient: {{ grants[0].recipientOrganization[0].name }})</small>
                    {% endif %}
                    {% if queryParams.orgType %}
                        <small v-show="filters.orgType">(Organisation Type: {{ grants[0].recipientOrganization[0].organisationType }})</small>
                    {% endif %}
                </span> #}

                <div class="grants-searchbar">
                    <label class="u-visually-hidden" for="search-query">Search</label>
                    <div class="form-field-addon">
                        <input class="form-field-addon__input"
                                type="search"
                                id="search-query"
                                name="q"
                                value="{{ queryParams.q }}"
                                placeholder="Enter a keyword"
                                autocomplete="nope"
                                @input="debounceQuery">
                        <input class="form-field-addon__action" type="submit" value="Search" />
                    </div>
                </div>

                <div class="grants-search">
                    <div class="grants-search__meta" v-bind:class="{ 'u-invisible': isCalculating }">

                        <h2 class="grants-search__total accent--{{ pageAccent }} t--underline" v-cloak>
                            <grants-total-summary
                                :total-results="totalResults"
                                :total-awarded="totalAwarded"
                            />
                            <noscript>{{ meta.totalResults | numberWithCommas }} projects found</noscript>
                        </h2>

                        <div class="grants-search__sort">
                            {# @TODO should there be a way to remove sorts and return to default? #}
                            {# @TODO should sort controls be considered progressive enhancement #}
                            <div class="sort-controls">
                                <span class="sort-controls__prefix">
                                    Sort:
                                </span>

                                <noscript>
                                    {% if meta.currentSort.type === 'awardDate' and meta.currentSort.direction === 'desc' %}
                                        <a class="sort-controls__item is-active is-descending"
                                            href="?{{ queryParams | addQueryParam([['sort', 'awardDate|asc']]) }}"
                                            aria-label="Sort by newest first">Award date</a>
                                    {% elseif meta.currentSort.type === 'awardDate' and meta.currentSort.direction === 'asc'  %}
                                        <a class="sort-controls__item is-active is-ascending"
                                            href="?{{ queryParams | addQueryParam([['sort', 'awardDate|desc']]) }}"
                                            aria-label="Sort by oldest first">Award date</a>
                                    {% else %}
                                        <a class="sort-controls__item"
                                            href="?{{ queryParams | addQueryParam([['sort', 'awardDate|desc']]) }}"
                                            aria-label="Sort by oldest first">Award date</a>
                                    {% endif %}

                                    {% if meta.currentSort.type === 'amountAwarded' and meta.currentSort.direction === 'desc' %}
                                        <a class="sort-controls__item is-active is-descending"
                                            href="?{{ queryParams | addQueryParam([['sort', 'amountAwarded|asc']]) }}"
                                            aria-label="Sort by highest amount awarded first">Amount awarded</a>
                                    {% elseif meta.currentSort.type === 'amountAwarded' and meta.currentSort.direction === 'asc'  %}
                                        <a class="sort-controls__item is-active is-ascending"
                                            href="?{{ queryParams | addQueryParam([['sort', 'amountAwarded|desc']]) }}"
                                            aria-label="Sort by lowest amount awarded first">Amount awarded</a>
                                    {% else %}
                                        <a class="sort-controls__item"
                                            href="?{{ queryParams | addQueryParam([['sort', 'amountAwarded|desc']]) }}"
                                            aria-label="Sort by highest amount awarded first">Amount awarded</a>
                                    {% endif %}

                                    {% if meta.currentSort %}
                                        <input type="hidden" name="sort" value="{{ meta.currentSort.type }}|{{ meta.currentSort.direction }}">
                                    {% endif %}
                                </noscript>

                                <span class="js-only">

                                    <a class="sort-controls__item"
                                        v-bind:title="getSortTitle('Sort by newest first', 'Sort by oldest first')"
                                        v-bind:aria-label="getSortTitle('Sort by newest first', 'Sort by oldest first')"
                                        v-bind:class="sortLinkClasses('awardDate')"
                                        v-bind:href="'?' + filtersToString()"
                                        v-on:click.prevent="sortData('awardDate', sort.direction)"
                                        v-cloak>Award date</a>

                                    <a class="sort-controls__item"
                                        v-bind:title="getSortTitle('Sort by highest amount awarded first', 'Sort by lowest amount awarded first')"
                                        v-bind:aria-label="getSortTitle('Sort by highest amount awarded first', 'Sort by lowest amount awarded first')"
                                        v-bind:class="sortLinkClasses('amountAwarded')"
                                        v-bind:href="'?' + filtersToString()"
                                        v-on:click.prevent="sortData('amountAwarded', sort.direction)"
                                        v-cloak>Amount awarded</a>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="grants-search__content">

                        <div class="grants-search__results">
                            <div class="grants-search__status">
                                {# @TODO: Replace with single 'status' property #}
                                <grant-loading-status
                                    :is-calculating="isCalculating"
                                    :search-error="searchError"
                                />
                            </div>

                            <div id="js-grant-results" v-show="!isCalculating && !searchError">
                                {{ grantResultList(grants) }}
                            </div>
                        </div>

                        <div class="grants-search__filters">
                            {# Javascript component version of filters #}
                            <grant-filters
                                :facets="facets"
                                :filters="filters"
                                :is-calculating="isCalculating"
                                @clear-filters="clearFilters"
                            />

                            {# Noscript fallback filters #}
                            <noscript>
                                <div class="search-filters">
                                    {# Filter: Amount awarded #}
                                    {% if facets.amountAwarded %}
                                        {% set options = (facets.amountAwarded.unshift({
                                            'label': 'Any amount',
                                            'value': ''
                                        }), facets.amountAwarded) %}
                                        <div class="facet-group">
                                            {{ inputChoice({
                                                type: 'radio',
                                                name: 'amount',
                                                label: 'Amount awarded',
                                                value: queryParams.amount,
                                                options: options,
                                                silentlyOptional: true
                                            }) }}
                                        </div>
                                    {% endif %}

                                    {# Filter: Country #}
                                    {% if facets.countries %}
                                        {% set options = (facets.countries.unshift({
                                            'label': 'All countries',
                                            'value': ''
                                        }), facets.countries) %}
                                        <div class="facet-group">
                                            {{ inputChoice({
                                                type: 'radio',
                                                name: 'country',
                                                label: 'Country',
                                                value: queryParams.country,
                                                options: options,
                                                silentlyOptional: true
                                            }) }}
                                        </div>
                                    {% endif %}

                                    {# Filter: Grant programme #}
                                    {% if facets.grantProgramme %}
                                        {% set options = (facets.grantProgramme.unshift({
                                            'label': 'All programmes',
                                            'value': ''
                                        }), facets.grantProgramme) %}
                                        <div class="facet-group">
                                            {{ inputSelect({
                                                type: 'select',
                                                name: 'programme',
                                                label: 'Programme',
                                                value: queryParams.programme,
                                                options: options,
                                                silentlyOptional: true
                                            }) }}
                                        </div>
                                    {% endif %}

                                    {# Filter: Local Authority #}
                                    {% if facets.localAuthorities %}
                                        {% set options = (facets.localAuthorities.unshift({
                                            'label': 'All local authorities',
                                            'value': ''
                                        }), facets.localAuthorities) %}
                                        <div class="facet-group">
                                            {{ inputSelect({
                                                type: 'select',
                                                name: 'localAuthority',
                                                label: 'Local authority',
                                                value: queryParams.localAuthority,
                                                options: options,
                                                silentlyOptional: true
                                            }) }}
                                        </div>
                                    {% endif %}

                                    {# Filter: Constituency #}
                                    {% if facets.westminsterConstituencies %}
                                        {% set options = (facets.westminsterConstituencies.unshift({
                                            'label': 'All constituencies',
                                            'value': ''
                                        }), facets.westminsterConstituencies) %}
                                        <div class="facet-group">
                                            {{ inputSelect({
                                                type: 'select',
                                                name: 'constituency',
                                                label: 'Westminster constituency',
                                                value: queryParams.constituency,
                                                options: options,
                                                silentlyOptional: true
                                            }) }}
                                        </div>
                                    {% endif %}

                                    <div class="search-filters__actions">
                                        <input type="submit" value="Filter" class="btn btn--medium">
                                    </div>
                                </div>
                            </noscript>
                        </div>
                    </div>
                </div>{# End grants-search #}
            </form>
        </div>
    </main>
{% endblock %}
