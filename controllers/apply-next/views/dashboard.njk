{% from "components/buttons.njk" import startButton, startButtonSubmit %}
{% from "components/content-box/macro.njk" import contentBox %}
{% from "components/form-header/macro.njk" import formHeader with context %}
{% from "components/form-fields/macros.njk" import formErrors, formField with context %}
{% from "components/icons.njk" import iconBin %}
{% from "./view-helpers.njk" import showSectionProgress with context %}

{% extends "layouts/main.njk" %}

{% set fieldMissing %}<span class="application-data-missing">not yet completed</span>{% endset %}

{% macro getStartDate(dateParts) %}
    {% if dateParts.day and dateParts.month and dateParts.year %}
        {{ dateParts.day }}/{{ dateParts.month }}/{{ dateParts.year }}
    {% else %}
        {{ fieldMissing | safe }}
    {% endif %}
{% endmacro %}

{% macro getGrantAmount(budget) %}

{% endmacro %}

{% macro getApplicationSummary(application) %}
    <ul class="u-margin-top">
        <li>
            Proposed start date:
            {% if application.application_data['project-start-date'] %}
                {{ getStartDate(application.application_data['project-start-date']) }}
            {% else %}
                {{ fieldMissing | safe }}
            {% endif %}
        </li>
        <li>
            Grant amount:
            {% if application.grantAmount %}
                Â£{{ application.grantAmount }}
            {% else %}
                {{ fieldMissing | safe }}
            {% endif %}
        </li>
        <li>
            Organisation:
            {% if application.application_data['organisation-legal-name'] %}
                {{ application.application_data['organisation-legal-name'] }}
            {% else %}
                {{ fieldMissing | safe }}
            {% endif %}
        </li>
        <li>
            Project location:
            {% if application.application_data['project-postcode'] %}
                {{ application.application_data['project-postcode'] }}
            {% else %}
                {{ fieldMissing | safe }}
            {% endif %}
        </li>
    </ul>
{% endmacro %}

{% block content %}
    <main role="main" id="content">
        {% call contentBox() %}
            <h1>Your applications</h1>
            <p>
                Here you can check the status of an online application in progress.<br />
                You can also <a href="{{ formBaseUrl }}/new">start a brand new application</a> and see any applications you've previously submitted online.
            </p>

            {% if applications.length > 0 %}

                <h2 class="t2 t--underline">In progress</h2>

                {% for application in applications %}
                    <div class="u-tone-background-tint u-margin-bottom-l">
                        <div class="flex-grid">

                            {# Application summary info #}
                            <div class="flex-grid__item u-no-margin">
                                <div class="u-padded">
                                    <small><strong>{{ formTitle }}</strong></small>
                                    <h3 class="t3 t--underline u-tone-brand-primary">{{ application.application_title }}</h3>
                                    {{ getApplicationSummary(application) }}
                                    <div class="o-button-group-flex">
                                        {% if application.status === 'complete' %}
                                            <a class="btn btn--small btn--outline" href="{{ formBaseUrl }}/edit/{{ application.id }}">
                                                View application
                                            </a>
                                            <a class="btn btn--small btn--outline" href="#">
                                                Download (PDF)
                                            </a>
                                        {% else %}
                                            <a class="btn" href="{{ formBaseUrl }}/edit/{{ application.id }}">
                                                Continue with this application
                                            </a>
                                            <a class="btn btn--medium btn--outline btn--reversed"
                                               href="{{ formBaseUrl }}/delete/{{ application.id }}">
                                                {{ iconBin() }}
                                                Delete application
                                            </a>
                                        {% endif %}

                                        <small>
                                            <strong>Guidance for this programme:</strong><br />
                                            <a href="{{ form.documentation.guidance }}">{{ formTitle }} guidance</a><br />
                                            <a href="{{ form.documentation.terms }}">Terms and Conditions for {{ formTitle }}</a>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            {# Section progress #}
                            <div class="flex-grid__item u-no-margin u-tone-background-tint--medium">
                                <div class="u-padded">
                                    <div class="u-padded u-tone-background-tint">
                                        <small><strong>Application status:</strong></small>
                                        <h3 class="t3">{{ application.status or "unknown" }}</h3>
                                        <p class="u-margin-top">
                                            You started your application on {{ formatDate(application.createdAt.toISOString(), DATE_FORMATS.numeric) }}<br />
                                            It must be completed by ???
                                        </p>
                                    </div>

                                    <div class="application-summary">
                                        {% for section in form.sections %}
                                            {% set sectionProgress = application.progress.sections[section.slug] %}
                                            <header class="application-summary__status application-summary__status--mini application-summary__status--{{ sectionProgress }} u-tone-background-tint">
                                                <small>{{ loop.index }}: {{ section.title }}</small>
                                                {{ showSectionProgress(sectionProgress) }}
                                            </header>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            <h2>Start a new application</h2>
            {# @TODO: Should this go to the start page? #}
            <p><a href="{{ formBaseUrl }}/new" class="btn">New application</a></p>

        {% endcall %}
    </main>
{% endblock %}
