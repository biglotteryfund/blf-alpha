{% from "components/breadcrumb-trail/macro.njk" import breadcrumbTrail %}
{% from "components/content.njk" import flexibleContent %}
{% from "components/inline-links/macro.njk" import inlineLinks %}
{% from "components/hero.njk" import hero with context %}

{% extends "layouts/main.njk" %}

{% macro articleMeta(entry) %}
    <div class="article-meta">

        <div class="u-tone-background-tint u-padded u-margin-bottom">
            <h3 class="t5">{% if entry.authors.length > 1 %}Authors{% else %}Author{% endif %}</h3>
            {% for author in entry.authors -%}
                <aside class="o-media">
                    {% if author.photo %}
                        <img src="{{ author.photo }}"
                             alt="{{ author.title }}"
                             class="o-media-figure"
                             width="60"/>
                    {% endif %}
                    <div class="o-media-body">
                        <p class="u-no-margin"><strong>{{ author.title }}</strong></p>
                        {% if author.authorTitle %}
                            <p>
                                {{ author.authorTitle }}
                                {% if author.shortBiography %}
                                    <br>
                                    {{ author.shortBiography}}
                                {% endif %}
                            </p>
                        {% endif %}
                    </div>
                </aside>
                <p class="u-margin-top-s"><a href="{{ localify('/news/blog?author=' + author.slug) }}">See all posts by this author</a></p>
            {% endfor %}
        </div>


        <div class="u-tone-background-tint u-padded u-margin-bottom">
            <h3 class="t5">About this post</h3>
            <p class="article-meta__pubdate u-margin-bottom-s">
                <strong>Date published:</strong>
                <time datetime="{{ entry.postDate.date }}">
                    {{ formatDate(entry.postDate.date, DATE_FORMATS.short) }}
                </time>
            </p>
            <div class="article-listing__meta__tags">
                <ul class="tags-list">
                    <li class="tag">
                        <a href="{{ localify('/news/blog/?category=' + entry.category.slug) }}">
                            {{ entry.category.title }}
                        </a>
                    </li>
                    {% for tag in entry.tags %}
                        <li class="tag tag--secondary">
                            <a href="{{ localify('/news?tag=' + tag.slug) }}">
                                {{ tag.title }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>


    </div>
{% endmacro %}

{% block content %}
    {% set pageAccent = 'pink' %}

    <main role="main">

        {{ hero(
            titleText = title,
            image = heroImage,
            accent = pageAccent
        ) }}

        <div class="nudge-up">
            <section class="content-box u-inner-wide-only accent--{{ pageAccent }} a--border-top">
                {{ breadcrumbTrail(breadcrumbs) }}

                <article class="article">

                    <div class="article__main">
                        <footer class="article__meta accent--{{ pageAccent }} a--border-color">
                            {{ articleMeta(entry) }}
                        </footer>
                        <div class="article__body">
                            {% if entry.body %}
                                <div class="s-prose">
                                    {{ entry.body | safe }}
                                </div>
                            {% else %}
                                {{ flexibleContent(entry.content, pageAccent) }}
                            {% endif %}
                        </div>
                    </div>
                    {% if entry.tags.length > 0 %}
                        <aside class="article__topics" role="aside">
                            {% set links = [] %}
                            {% for tag in entry.tags %}
                                {% set links = (links.push({ "label": tag.title, "url": localify('/news?tag=' + tag.slug) }), links) %}
                            {% endfor %}
                            {{ inlineLinks(prefix = __('global.misc.topics') | title, links = links) }}
                        </aside>
                    {% endif %}

                    {% if entry.relatedFundingProgrammes.length > 0 %}
                        <div class="u-tone-background-tint u-padded u-margin-top-l">
                            {% for programme in entry.relatedFundingProgrammes %}
                                <div class="o-media u-margin-bottom">
                                    {% if programme.photo %}
                                        <img src="{{ programme.photo.small }}"
                                             alt="{{ programme.title }}"
                                             class="o-media-figure"
                                             width="160" />
                                    {% endif %}
                                    <div class="o-media-body">
                                        <h4 class="a--text accent--{{ pageAccent }}">{{ programme.title }}</h4>
                                        {{ programme.intro | safe }}
                                        <p><a href="{{ programme.linkUrl }}">Read more about this programme</a></p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </article>
            </section>
        </div>
    </main>
{% endblock %}
