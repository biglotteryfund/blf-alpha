{% extends "layouts/main.njk" %}
{% from "components/breadcrumb-trail/macro.njk" import breadcrumbTrail %}
{% from "components/content-box/macro.njk" import contentBox %}
{% from "components/data.njk" import statsGrid %}
{% from "components/user-status/macro.njk" import staffStatus with context %}

{% block extraHead %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js" integrity="sha256-CutOzxCRucUsn6C6TcEYsauvvYilEniTXldPa6/wu0k=" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.3/daterangepicker.min.js" integrity="sha256-cpdGuiwvKhwkQY18xx0CNJBb9AhGOYKsAz6ea7LaB30=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.3/daterangepicker.min.css" integrity="sha256-DnG3ryf8FsLvOmNjwO9S4+Fpju6QECDbhLbWCtpn7Bc=" crossorigin="anonymous" />
    <script>
        $(function() {
            $('.js-datepicker-trigger')
                .daterangepicker({
                    maxDate: new Date(),
                })
                .on('apply.daterangepicker', function(event, picker) {
                    const s = picker.startDate.format('YYYY-MM-DD');
                    const e = picker.endDate.format('YYYY-MM-DD');
                    const existingSearch = window.location.search;
                    const dateQuery = `start=${s}&end=${e}`;
                    window.location = existingSearch ? `${existingSearch}&${dateQuery}` : `?${dateQuery}`;
                });

            $('.js-country').change(function() {
                const c = $(this).val();
                window.location = (c === 'uk') ? '?' : `?country=${c}`;
            })
        });
    </script>
    <style>
        .datepicker {
            font-size: 14px;
            vertical-align: middle;
        }
        .country-picker label,
        .country-picker select {
            font-size: 14px;
        }

        .country-picker label {
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
    <main role="main" id="content">
        <div class="content-box u-inner-wide-only">
            {{ breadcrumbTrail(breadcrumbs) }}
            {{ staffStatus(user) }}

            <h1 class="t--underline">
                Applications dashboard &ndash;
                {{ applicationTitle -}}
                {%- if countryTitle -%}
                    : {{ countryTitle }}
                {%- endif -%}
            </h1>

            <h2>
                Date range:
                {% if dateRange %}
                    {{ formatDate(dateRange.start, DATE_FORMATS.short) }} &mdash;
                    {{ formatDate(dateRange.end, DATE_FORMATS.short) }}
                {% else %}
                    {# @TODO - what is this range? #}
                    the last five months
                {% endif %}
                <a class="js-datepicker-trigger datepicker" href="javascript://">Change dates?</a>
                {% if dateRange %}
                    <a class="datepicker" href="?">or Reset dates?</a>
                {% endif %}
            </h2>

            <form class="country-picker u-margin-bottom-l u-margin-top">
                <label>Choose a country:</label>
                {% set countries = [
                    {
                        'value': 'uk',
                        'label': 'UK-wide'
                    },
                    {
                        'value': 'england',
                        'label': 'England'
                    },
                    {
                        'value': 'northern-ireland',
                        'label': 'Northern Ireland'
                    },
                    {
                        'value': 'scotland',
                        'label': 'Scotland'
                    },
                    {
                        'value': 'wales',
                        'label': 'Wales'
                    }
                ] %}
                <select class="js-country">
                    {% for c in countries %}
                        <option value="{{ c.value }}"{% if c.value === country %} selected="selected"{% endif %}>
                            {{ c.label }}
                        </option>
                    {% endfor %}
                </select>
            </form>

            {% for appType in applicationData %}
                <h3>{{ appType.title }}</h3>

                <div class="u-margin-bottom-l">
                    {{ statsGrid(
                        [
                            {
                                prefix: 'there were',
                                value: appType.data.totals.applicationsToday,
                                title: 'applications ' + appType.verb + ' today',
                                showNumberBeforeTitle: true
                            },
                            {
                                prefix: 'and a total of',
                                value: appType.data.totals.applicationsAll,
                                title: 'applications ' + appType.verb,
                                showNumberBeforeTitle: true
                            },
                            {
                                prefix: 'made by',
                                value: appType.data.totals.uniqueUsers,
                                title: 'unique users',
                                showNumberBeforeTitle: true
                            }
                        ]
                    ) }}
                </div>

                <div class="u-margin-bottom-l">

                    {% set chartId = 'js-chart-' + appType.id %}
                    <h3>{{ appType.title }} &ndash; day-by-day</h3>
                    <div class="u-margin-bottom">
                        <canvas id="{{ chartId }}" height="300"></canvas>
                    </div>
                    <script>
                        new Chart(document.getElementById('{{ chartId }}'), {
                            type: 'bar',
                            data: {
                                {% if country %}
                                    datasets: [{
                                        label: '{{ appType.title }}',
                                        data: {{ appType.data.appsPerDay | dump(2) | safe }},
                                        borderColor: '#e5007d',
                                        fill: '#e5007d'
                                    }]
                                {% else %}
                                    datasets: [
                                        {% for country in appType.appsByCountryByDay %}
                                            {
                                                label: '{{ country.title }}',
                                                data: {{ country.data | dump(2) | safe }},
                                                borderColor: '{{ country.colour }}',
                                                fill: '{{ country.colour }}',
                                                backgroundColor: '{{ country.colour }}'
                                            },
                                        {% endfor %}
                                    ]
                                {% endif %}
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                title: {
                                    display: false,
                                    text: 'Response distribution'
                                },
                                legend: {
                                    display: {% if country %}false{% else %}true{% endif %}
                                },
                                scales: {
                                    xAxes: [{
                                        type: 'time',
                                        offset: true,
                                        display: true,
                                        scaleLabel: {
                                            display: false,
                                            labelString: 'Date'
                                        },
                                        ticks: {
                                            major: {
                                                fontStyle: 'bold',
                                                fontColor: '#FF0000'
                                            }
                                        },
                                        time: {
                                            round: 'day',
                                            unit: 'day'
                                        },
                                        gridLines: {
                                            display: true
                                        }
                                    }],
                                    yAxes: [{
                                        display: true,
                                        ticks: {
                                            stepSize: 10,
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: "{{ appType.title }}"
                                        },
                                        gridLines: {
                                            display: true
                                        }
                                    }]
                                }
                            }
                        });
                    </script>

                </div>
            {% endfor %}


            <div class="u-margin-bottom-l">
                <h3>Application durations  <small>(days from start to submission)</small></h3>
                {{ statsGrid(
                    [
                        {
                            prefix: 'Quickest applicant took',
                            value: statistics.appDurations.lowest + ' days',
                            title: 'to submit their form',
                            showNumberBeforeTitle: true
                        },
                        {
                            prefix: 'Applicants on average took',
                            value: statistics.appDurations.average | round(2) + ' days',
                            title: 'to submit their form',
                            showNumberBeforeTitle: true
                        },
                        {
                            prefix: 'Slowest applicant took',
                            value: statistics.appDurations.highest + ' days',
                            title: 'to submit their form',
                            showNumberBeforeTitle: true
                        }
                    ]
                ) }}
            </div>

            <div class="u-margin-bottom-l">

                <h3>Application word counts <small>(approximate totals only)</small></h3>
                {{ statsGrid(
                    [
                        {
                            prefix: 'Briefest applicant wrote',
                            value: statistics.wordCount.lowest | round + ' words',
                            showNumberBeforeTitle: true
                        },
                        {
                            prefix: 'Applicants on average wrote',
                            value: statistics.wordCount.average | round + ' words',
                            showNumberBeforeTitle: true
                        },
                        {
                            prefix: 'Wordiest applicant wrote',
                            value: statistics.wordCount.highest | round + ' words',
                            showNumberBeforeTitle: true
                        }
                    ]
                ) }}
            </div>

            <div class="u-margin-bottom-l">
                <h3>Funding amount requested</h3>
                {{ statsGrid(
                    [
                        {
                            prefix: 'Applicants requested a total of',
                            value: '£' + statistics.requestedAmount.total.toLocaleString(),
                            title: 'over ' + statistics.totalSubmitted + ' applications',
                            showNumberBeforeTitle: true
                        },
                        {
                            value: '£' + (statistics.requestedAmount.average | round).toLocaleString(),
                            title: 'Average funding request',
                            showNumberBeforeTitle: false
                        },
                        {
                            value: '£' + (statistics.requestedAmount.lowest).toLocaleString(),
                            title: 'Smallest funding request',
                            showNumberBeforeTitle: false
                        }
                    ]
                ) }}
            </div>

            {% if feedback %}
                <div class="u-margin-bottom-l"  style="max-height: 400px; overflow: auto">
                    <h3>Successful applicant feedback <small>({{ feedback.length }} responses)</small></h3>
                    <ul>
                        {% for f in feedback %}
                            <li>
                                <blockquote class="blockquote">
                                    <div class="blockquote__text">
                                        {{ f.message | safe }}
                                    </div>
                                    <cite class="blockquote__cite">
                                        {{ formatDate(f.createdAt.toISOString(), DATE_FORMATS.short) }}
                                    </cite>
                                </blockquote>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if dataStudioUrl %}
                <div class="u-margin-bottom-l">
                    <h3>User analytics for form usage <small>(not using the above date range)</small></h3>

                    <div style="position:relative;padding-top:56.25%;">
                        <iframe src="{{ dataStudioUrl }}" frameborder="0" allowfullscreen
                                style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe>
                    </div>
                </div>
            {% endif %}

        </div>

    </main>

{% endblock %}
