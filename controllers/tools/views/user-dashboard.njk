{% extends "layouts/main.njk" %}
{% from "components/breadcrumb-trail/macro.njk" import breadcrumbTrail %}
{% from "components/staff-status/macro.njk" import staffStatus with context %}

{% block extraHead %}
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
{% endblock %}

{% macro dateItem(date) %}
    <abbr title="{{ date }}">{{ formatDate(date) }}</abbr>
{% endmacro %}

{% macro yesNo(bool) %}
    {% if bool %}Yes{% else %}No{% endif %}
{% endmacro %}

{% macro deSlugify(str) %}
    {{ str | replace('-', ' ') | replace('_', ' ') | title }}
{% endmacro %}

{%- macro statusClass(status) -%}
    {%- if status === 'COMPLETE' -%}
        table-success
    {%- elseif status === 'NOT_STARTED' -%}
        table-warning
    {%- else -%}
        table-primary
    {%- endif -%}
{%- endmacro -%}

{% block content %}
    <main role="main" id="content">
        <div class="content-box u-inner-wide-only">
            {{ breadcrumbTrail(breadcrumbs) }}
            {{ staffStatus(user) }}

            <h1 class="u-margin-bottom-s t2">{{ title }}</h1>

            {% if statusMessage %}
                <div class="alert alert-success" role="alert">
                    {{ statusMessage }}
                </div>
            {% endif %}

            <form method="get" class="form-inline">
                <div class="form-group">
                    <label for="userEmail">Find a user by email address</label>
                    <input type="text" class="form-control mx-sm-3" id="userEmail" aria-describedby="emailHelp" placeholder="Enter email search" name="q">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
            <small id="emailHelp" class="form-text text-muted">You can search by a whole email address or just part of one, eg. "david" or "@gov.uk".</small>


            {% if singleUser %}
                <h2 class="t3 u-margin-top-l">
                    Funding applications by {{ singleUser.username }}
                    <small>{{ pendingApps.length + submittedApps.length }} application(s) found</small>
                </h2>


                <h3 class="t4 u-margin-top">
                    Pending applications
                    <small>{{ pendingApps.length }} total</small>
                </h3>
                {% if pendingApps.length > 0 %}

                    <table class="table table-striped table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">Title</th>
                                <th scope="col">Application type</th>
                                <th scope="col">Status</th>
                                <th scope="col">Date created</th>
                                <th scope="col">Date updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in pendingApps %}
                                <tr class="{{ statusClass(app.currentProgressState) }}">
                                    <td>{{ app.applicationData.projectName or 'Untitled' }}</td>
                                    <td>{{ deSlugify(app.formId) }}</td>
                                    <td>
                                        {{ deSlugify(app.currentProgressState) }}
                                    </td>
                                    <td>{{ dateItem(app.createdAt) }}</td>
                                    <td>{{ dateItem(app.updatedAt) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No pending applications found for this user</p>
                {% endif %}

                <h3 class="t4 u-margin-top">
                    Submitted applications
                    <small>{{ submittedApps.length }} total</small>
                </h3>
                {% if submittedApps.length > 0 %}


                    <table class="table table-striped table-bordered table-hover">
                        <thead class="thead-light">
                        <tr>
                            <th scope="col">Title</th>
                            <th scope="col">Country</th>
                            <th scope="col">Application type</th>
                            <th scope="col">Salesforce ID</th>
                            <th scope="col">Date submitted</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for app in submittedApps %}
                            <tr>
                                <td>{{ app.applicationTitle or 'Untitled' }}</td>
                                <td>{{ deSlugify(app.applicationCountry) | title }}</td>
                                <td>{{ deSlugify(app.formId) }}</td>
                                <td>{{ app.salesforceId }}</td>
                                <td>{{ dateItem(app.createdAt) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No submitted applications found for this user</p>
                {% endif %}

            {% endif %}

            {% if usernameSearch %}

                <h2 class="t3 u-margin-top-l">
                    Search results for "{{ usernameSearch }}"
                    <small>{{ users.length }} users found</small>
                </h2>

                {% if users %}
                    <table class="table table-striped table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">Email address</th>
                                <th scope="col">Activated?</th>
                                <th scope="col">In password reset mode?</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                                <tr>
                                    <td>
                                        {{ user.username }}<br />
                                        <small>
                                            <strong>User ID</strong>: {{ user.id }} <br />
                                            <strong>Registered</strong>: {{ dateItem(user.createdAt) }} <br />
                                            <strong>Last login</strong>: {{ dateItem(user.updatedAt) }}
                                        </small>
                                    </td>
                                    <td{% if not user.is_active %} class="table-danger"{% endif %}>
                                        {{ yesNo(user.is_active) }}
                                    </td>
                                    <td{% if user.is_password_reset %} class="table-danger"{% endif %}>
                                        {{ yesNo(user.is_password_reset) }}
                                    </td>
                                    <td>
                                        {% if not user.is_active or user.is_password_reset %}
                                            {% if not user.is_active %}
                                                <form method="post">
                                                    <input type="hidden" name="userToActivate" value="{{ user.id }}" />
                                                    <button type="submit" class="btn btn-block btn-sm btn-primary">Activate user</button>
                                                </form>
                                                <br />
                                            {% endif %}
                                            {% if user.is_password_reset %}
                                                <form method="post">
                                                    <input type="hidden" name="userToSendPasswordReset" value="{{ user.id }}" />
                                                    <button type="submit" class="btn btn-block btn-sm btn-secondary">Send password reset email</button>
                                                </form>
                                                <br />
                                            {% endif %}
                                        {% endif %}
                                        <form method="get">
                                            <input type="hidden" name="appsById" value="{{ user.id }}" />
                                            <button type="submit" class="btn btn-block btn-sm btn-info">View applications</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}

            {% endif %}

        </div>
    </main>
{% endblock %}
