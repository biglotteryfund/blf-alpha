{% extends "layouts/main.njk" %}

{% from "components/hero.njk" import hero with context %}
{% from "components/content-box/macro.njk" import contentBox %}
{% from "components/breadcrumb-trail/macro.njk" import breadcrumbTrail %}
{% from "components/article-teaser/macro.njk" import articleTeaser %}
{% from "components/split-nav/macro.njk" import splitNav %}
{% from "components/icons.njk" import iconClose %}
{% from "components/form-fields/macros.njk" import inputChoice, inputSelect with context %}

{% from "../../updates/views/view-helpers.njk" import entryRegions with context %}
{% from "../../grants/views/helpers.njk" import facetGroup %}

{% set basePageUrl = localify('/insights/documents') %}

{% block content %}
    <main role="main" id="content">
        {{ hero(title, pageHero.image) }}

        <div class="nudge-up">
            {{ breadcrumbTrail(breadcrumbs) }}
            {% call contentBox() %}
                {{ copy.intro | safe }}
            {% endcall %}
        </div>

        <form class="u-inner" method="get" action="">

            <div class="search-bar">
                <label class="ff-label"
                       for="search-query">
                    Search our documents
                </label>
                <div class="form-field-addon u-margin-bottom-s">
                    <input
                        class="form-field-addon__input"
                        type="search"
                        id="search-query"
                        name="q"
                        autocomplete="off"
                        data-hj-whitelist
                    />
                    <input
                        class="form-field-addon__action"
                        type="submit"
                        value="Search"
                    />
                </div>
                <p class="ff-help u-no-margin">
                    Search for a keyword such as "loneliness" or an organisation name
                </p>
            </div>

            <div class="search">

                {# Search totals #}
                <div class="search__meta">
                    <h2 class="search__total t--underline">
                        {{ researchEntries.length }} document{{ researchEntries.length | pluralise("", "s") }} found
                    </h2>
                </div>

                <div class="search__meta">
                    {# Filter summary #}

                    <ul class="filter-list">
                        {% if entriesMeta.activeProgramme or entriesMeta.activePortfolio or entriesMeta.activeDocType %}
                            {% macro filterField(field, param) %}
                                {% if field %}
                                    <li class="filter-list__item">
                                        <a class="active-filter"
                                           title="{{ field.label }}"
                                           href="?{{ queryParams | removeQueryParam(param) }}">
                                            {{ field.label }}
                                            {{ iconClose() }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endmacro %}

                            {{ filterField(entriesMeta.activeProgramme, 'programme') }}
                            {{ filterField(entriesMeta.activePortfolio, 'portfolio') }}
                            {{ filterField(entriesMeta.activeDocType, 'doctype') }}

                            <li class="filter-list__item">
                                <a class="btn-link" href="{{ basePageUrl }}">Clear all filters</a>
                            </li>
                        {% endif %}
                    </ul>

                    {# Sort controls #}
                    <div class="search__sort">
                        <div class="sort-controls">
                            <label class="ff-label" for="field-sort">Ordered by</label>
                            <select
                                class="ff-select"
                                name="sort"
                                id="field-sort"
                            >
                                <option>Most relevant</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="search__content">

                    <div class="search__results">
                        {% if researchEntries.length > 0 %}
                            <ol class="article-listing">
                                {% for entry in researchEntries %}
                                    <li class="article-listing__item">
                                        {% set subtitle %}
                                            {% if entry.documentType %}
                                                <strong>{{ entry.documentType.title }}</strong>
                                            {% endif %}
                                            <time class="article-teaser__pubdate" datetime="{{ props.postDate.date }}">
                                                published in {{ formatDate(entry.postDate.date, 'YYYY') }}
                                            </time>
                                            {% if entry.portfolio.length > 0 %}
                                                in {{ entryRegions(entry.portfolio, currentPath) }}
                                            {% endif %}
                                            {% if entry.publisher %}
                                                by {{ entry.publisher }}
                                            {% endif %}
                                            {% if entry.partnershipName %}
                                                in partnership with {{ entry.partnershipName }}
                                            {% endif %}
                                            {% if entry.relatedFundingProgrammes %}
                                                relating to
                                                {% for programme in entry.relatedFundingProgrammes %}
                                                    <a href="{{ localify(programme.linkUrl) }}">{{ programme.title }}</a>
                                                {% endfor %}
                                            {% endif %}
                                            {% if entry.tags %}
                                                tagged with
                                                {% for tag in entry.tags %}
                                                    <a href="?tag={{ tag.slug }}">{{ tag.title }}</a>
                                                {% endfor %}
                                            {% endif %}
                                        {% endset %}

                                        {% set docTitle = entry.title + ' (' + entry.document.filetype | upper + ', ' + entry.document.filesize + ')' %}

                                        {{ articleTeaser({
                                            'title': docTitle,
                                            'subtitle': subtitle | safe,
                                            'summary': entry.summary,
                                            '_linkUrl': entry.linkUrl,
                                            'linkUrl': entry.document.url
                                        }) }}
                                    </li>
                                {% endfor %}
                            </ol>

                            {% if pagination %}
                                {{ splitNav(
                                    prevLink = {
                                        "label": __('global.misc.pagination.prev'),
                                        "url": pagination.prevLink
                                    },
                                    nextLink = {
                                        "label": __('global.misc.pagination.next'),
                                        "url": pagination.nextLink
                                    }
                                ) }}
                            {% endif %}
                        {% else %}
                            <p>No results @TODO</p>
                        {% endif %}
                    </div>

                    <div class="search__controls">

                        <fieldset class="search-filters">
                            <div class="search-filters__header">
                                <legend class="search-filters__title">Filter by</legend>
                                <a class="search-filters__clear-all btn-link" href="{{ basePageUrl }}">
                                    Clear all
                                </a>
                            </div>

                            {% call facetGroup('Funding programme') %}
                                {{ inputSelect({
                                    type: 'select',
                                    name: 'programme',
                                    value: entriesMeta.activeProgramme.value if entriesMeta.activeProgramme,
                                    options: entriesMeta.programmes,
                                    silentlyOptional: true
                                }) }}
                            {% endcall %}

                            {% call facetGroup('Country') %}
                                {{ inputSelect({
                                    type: 'select',
                                    name: 'portfolio',
                                    value: entriesMeta.activePortfolio.value if entriesMeta.activeProgramme,
                                    options: entriesMeta.portfolios,
                                    silentlyOptional: true
                                }) }}
                            {% endcall %}

                            {% call facetGroup('Document type') %}
                                {{ inputChoice({
                                    type: 'radio',
                                    name: 'doctype',
                                    value: entriesMeta.activeDocType.value if entriesMeta.activeDocType,
                                    options: entriesMeta.docTypes,
                                    silentlyOptional: true
                                }) }}
                            {% endcall %}

                            <div class="search-filters__actions">
                                <input type="submit" value="Submit" class="btn btn--medium">
                            </div>

                        </fieldset>

                    </div>
                </div>
            </div>

        </form>

    </main>
{% endblock %}
