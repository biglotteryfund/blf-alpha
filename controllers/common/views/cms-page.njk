{% from "components/hero.njk" import hero with context %}
{% from "components/breadcrumb-trail/macro.njk" import breadcrumbTrail %}
{% from "components/content-box/macro.njk" import contentBox %}
{% from "components/segment-links/macro.njk" import segmentLinks %}
{% from "components/segment/macro.njk" import segment %}
{% from "components/flexible-content/macro.njk" import flexibleContentPart %}
{% from "components/miniature-hero/macro.njk" import miniatureHero %}
{% from "components/section-links/macro.njk" import sectionLinks %}

{% extends "layouts/main.njk" %}
{% if not pageHero.image %}{% set bodyClass = 'has-static-header' %}{% endif %}

{% set flexAnchor = 'item' %}

{% block content %}

    {% if pageHero.image %}
        {{ hero(title, pageHero.image) }}
    {% endif %}


    <main role="main" id="content" {% if pageHero.image %}class="nudge-up"{% endif %}>
        {% block contentPrimary %}

            {% if content.introduction %}
                <section class="content-box u-inner-wide-only">
                    {{ breadcrumbTrail(breadcrumbs) }}

                    <div class="s-prose u-constrained-content-wide">
                        {% if not pageHero.image %}
                            <h1>{{ content.title }}</h1>
                        {% endif %}
                        {{ content.introduction | safe }}
                    </div>
                    {% if not childrenLayoutMode %}
                        {% if content.segments.length > 0 %}
                            {{ segmentLinks(content.segments) }}
                        {% endif %}
                        {% if content.flexibleContent %}
                            {{ segmentLinks(content.flexibleContent, anchor = flexAnchor) }}
                        {% endif %}
                    {% endif %}
                </section>
            {% endif %}

            {# Content segments #}
            {% if content.segments.length > 0 %}
                <div class="u-inner-wide-only u-constrained-content-wide">
                    {% for contentSegment in content.segments %}
                        {% call segment(
                            id = 'segment-' + loop.index,
                            title = contentSegment.title,
                            imagePath = contentSegment.photo
                        ) %}
                            {{ contentSegment.content | safe }}
                        {% endcall %}
                    {% endfor %}
                </div>
            {% endif %}

            {# Flexible content #}
            {% if content.flexibleContent %}
                {% for part in content.flexibleContent %}
                    <section class="content-box u-inner-wide-only"
                             id="{{ flexAnchor + '-' + loop.index }}">

                        {# Show breadcrumbs inside the first item's container if they weren't already shown #}
                        {% if loop.first and not content.introduction %}
                            {{ breadcrumbTrail(breadcrumbs) }}
                        {% endif %}

                        <div class="s-prose u-constrained-content-wide">
                            {{ flexibleContentPart(part) }}
                        </div>

                        {# Show links to the child pages inside the first item if it's a single-item list #}
                        {% if loop.last and
                            childrenLayoutMode === 'plain' and
                            content.children.length > 0 and
                            content.flexibleContent.length === 1 %}
                            {{ sectionLinks(content.children) }}
                        {% endif %}
                    </section>
                {% endfor %}
            {% endif %}

        {% endblock %}


        {% if content.children.length > 0 %}
            {% if childrenLayoutMode === 'heroes' %}
                <section class="u-inner">
                    <ul class="flex-grid">
                        {% for page in content.children %}
                            <li class="flex-grid__item">
                                {{ miniatureHero({
                                    "title": page.trailText | default(page.title, true),
                                    "linkUrl": page.linkUrl,
                                    "image": { "url": page.trailImage if page.trailImage else page.photo }
                                }, isLarge = true) }}
                            </li>
                        {% endfor %}
                    </ul>
                </section>
            {% elseif childrenLayoutMode === 'plain' and content.flexibleContent.length > 1 %}
                {# Show the child page links if they weren't shown above (eg. multi-item flexible content #}
                <section class="content-box u-inner-wide-only">
                    {{ sectionLinks(content.children) }}
                </section>
            {% endif %}
        {% endif %}

        {% if content.outro %}
            {% call contentBox() %}
                {{ content.outro | safe }}
            {% endcall %}
        {% endif %}

    </main>
{% endblock %}
