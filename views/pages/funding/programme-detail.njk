{% from "components/hero.njk" import hero %}
{% from "components/tabs.njk" import tabs %}
{% from "components/programmes.njk" import programmeStats with context %}
{% from "components/caseStudies.njk" import caseStudyCollection with context %}

{% extends "layouts/main.njk" %}

{% if entry.summary.area.value === 'wales' %}
    {% set bodyClass = "has-welsh-logo" %}
{% endif %}
{% set socialImage = heroImage %}

{% block title %}{{ title }} | {% endblock %}

{% block content %}
    {% set pageAccent = 'pink' %}

    <main role="main">
        {{ hero(
            titleText = title,
            image = heroImage,
            accent = pageAccent
        ) }}

        <div class="nudge-up">
            <section class="content-box content-box--tinted
                inner--wide-only accent--{{ pageAccent }} a--border-top">
                <div class="s-prose u-constrained-content-wide">
                    {% if entry.intro %}
                        {{ entry.intro | safe }}
                    {% endif %}
                    {{ programmeStats(
                        fields = entry.summary,
                        isCompact = true
                    ) }}
                    {% if entry.heroCredit %}
                        <p class="u-credit u-no-margin">
                            <strong>{{ __('global.misc.imageCredit') }}:</strong>
                            {{ entry.heroCredit }}
                        </p>
                    {% endif %}
                </div>
            </section>

            {% macro nextPrevNav(entry, loopIdx) %}
                {% set zeroIndexed = loopIdx - 1 %}
                {% set nextSection = entry.contentSections[zeroIndexed + 1] %}
                {% set prevSection = entry.contentSections[zeroIndexed - 1] %}
                {% if nextSection or prevSection %}
                    <nav class="split-nav">
                        {% if prevSection %}
                            <a class="split-nav__prev" href="#section-{{ loopIdx - 1 }}">
                                {{ prevSection.title }}
                            </a>
                        {% endif %}
                        {% if nextSection %}
                            <a class="split-nav__next" href="#section-{{ loopIdx + 1 }}">
                                {{ nextSection.title }}
                            </a>
                        {% endif %}
                    </nav>
                {% endif %}
            {% endmacro %}

            <div class="inner--wide-only">
                {% if entry.contentSections.length > 1 %}

                    {% set tabItems = [] %}
                    {% for section in entry.contentSections -%}

                        {% set tabContent -%}
                            <div class="content-box content-box--frameless">
                                <div class="s-prose u-constrained-content-wide
                                    accent-content--{{ pageAccent }} js-content">
                                    {{ section.body | safe }}
                                </div>

                                {{ nextPrevNav(entry, loop.index) }}
                            </div>
                        {%- endset %}

                        {% set tabItems = (tabItems.push({
                            "id": "section-" + loop.index,
                            "title": section.title,
                            "content": tabContent,
                            "active": loop.index === 1
                        }), tabItems) %}
                    {%- endfor %}

                    {{
                        tabs(
                            id = entry.title | slugify,
                            content = tabItems
                        )
                    }}
                {% else %}
                    {% set section = entry.contentSections[0] %}
                    <div class="content-box content-box--borderless">
                        <div class="s-prose u-constrained-content-wide accent-content--{{ pageAccent }}">
                            <h2 class="t2 t--underline accent--{{ pageAccent }} a--text">{{ section.title }}</h2>
                            {{ section.body | safe }}
                        </div>
                    </div>
                {% endif %}
            </div>

            {# Case Studies #}
            {{ caseStudyCollection(
                caseStudies = entry.caseStudies,
                customSectionTitle = __('global.misc.projectExamples'),
                accent = pageAccent
            ) }}
        </div>
    </main>
{% endblock %}
